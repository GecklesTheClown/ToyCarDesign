---
title: "R Notebook"
output: html_notebook
---

#Toy Car Distance Optimization

## Premable + Data Read

```{r, include=TRUE, warning=FALSE, message=FALSE, error=FALSE}

# refresh R, install + library required packages.
source("./scripts/setup.r") 

# Read in data
df <- read.csv(here("data","data.csv"))

# Make all our variables categorical factors
c_var <- c("Surface_type","Weight","Angle") 
df[,c_var] <- lapply(df[,c_var],factor)
```

## Exploratory Plots

```{r}
source(here("scripts","graphs.r"))
```

```{r}
ggarrange(distance, surface, weight, angle, labels = c("A","B","C","D"))
ggarrange(exp3,exp4)
```

## Model Selection 1 (Initial)

```{r}
# Remove Unnecessary Columns we can add them back later
df <- df[,-1]
df <- df[,-4:-6]


# Create Empty and Full Models for stepwise regression

m.empty <- lm(Distance_avg ~ 1,
              data = df)

m.full.1w <- lm(Distance_avg ~., 
              data = df)

m.full.2w <- lm(Distance_avg ~.^2, 
              data = df)

# Conduct Stepwise Regression


m.step.1w.f <- step(m.empty,
                direction = "forward")

m.step.1w.r <- step(m.full.1w,
                direction = "backward")

m.step.1w.b <- step(m.full.1w,
                direction = "both")

m.step.2w.b <- step(m.full.2w,
                direction = "both")

# Create a model list

model.list <- list(
  "Forward-One-Way" = m.step.1w.f,
  "Backward-One-Way" = m.step.1w.r,
  "Both-One-Way" = m.step.1w.b,
  "Both-Two-Way" = m.step.2w.b)

# Apply BIC to stepwise models

bics <- sapply(model.list,FUN = BIC)

# Tabulate BIC Results

plot_data <- data.frame(
                  model = c("Forward-One-Way",
                            "Backward-One-Way",
                            "Both-One-Way", 
                            "Both-Two-Way"),
                  Bic = bics)

knitr::kable(plot_data,row.names = FALSE,
             col.names = c("Model","BIC"))

```

## Model Evaluation 1 (Initial)

```{r}
## Obtain Model Summary
summary(m.step.1w.b)

# Check Linear Regression Assumptions
par(mfrow = c(2,2))
plot(m.step.1w.b$fitted.values,m.step.1w.b$residuals)
abline(h=0,col='red')
plot(m.step.1w.b$residuals,type = "l")
abline(h=0,col='red')
hist(m.step.1w.b$residuals)
qqnorm(m.step.1w.b$residuals)
qqline(m.step.1w.b$residuals)

```

## Model Selection 2 (log-transform)

```{r}
# Create Empty and Full models for stepwise (using log transformed response)

m.empty.log <- lm(log(Distance_avg) ~ 1,
              data = df)

m.full.1w.log <- lm(log(Distance_avg) ~., 
              data = df)

m.full.2w.log <- lm(log(Distance_avg) ~.^2, 
              data = df)


## conduct Stepwise Regression

m.step.1w.f.log <- step(m.empty.log,
                direction = "forward")

m.step.1w.r.log <- step(m.full.1w.log,
                direction = "backward")

m.step.1w.b.log <- step(m.full.1w.log,
                direction = "both")

m.step.2w.b.log <- step(m.full.2w.log,
                direction = "both")

# Create a Model List for Log Models

model.list <- list(
  "Forward-One-Way (Log)" = m.step.1w.f.log,
  "Backward-One-Way (Log)" = m.step.1w.r.log,
  "Both-One-Way (Log)" = m.step.1w.b.log,
  "Both-Two-Way (Log)" = m.step.2w.b.log)

# Apply BIC to all log stepwise models

bics.log <- sapply(model.list,FUN = BIC)

#Tabulate Results for log models
plot_data <- data.frame(
                  model = c("Forward-One-Way (Log)",
                            "Backward-One-Way (Log)",
                            "Both-One-Way (Log)", 
                            "Both-Two-Way (Log)"),
                  Bic = bics.log)

knitr::kable(plot_data,row.names = FALSE,
             col.names = c("Model","BIC"))

```

We can create a nested model without weight and use an partial-f test to compare with hypotheses:

- H0: $b_w=0$
- H1: $b_w\ne0$

```{r}

nested.log <- lm(formula = log(Distance_avg) ~ Surface_type + Angle +
    Surface_type:Angle, data = df)


anova(nested.log,m.step.2w.b.log)
```


## Model Section 2

```{r}
# Summary of best model
summary(m.step.2w.b.log)


# Check Linear Assumptions
par(mfrow = c(2,2))
plot(m.step.2w.b.log$fitted.values,m.step.2w.b.log$residuals)
abline(h=0,col='red')
plot(m.step.2w.b.log$residuals,type = "l")
abline(h=0,col='red')
hist(m.step.2w.b.log$residuals)
qqnorm(m.step.2w.b.log$residuals)
qqline(m.step.2w.b.log$residuals)

```

## Model Stastics 

```{r}
x <- glance(m.step.1w.b)
y <- glance(m.step.2w.b.log)
z <- glance(nested.log)
models <- c("Inital: Step One Way", "Intermediate: Step Two Way (log)", "Final : Nested (log)")


rdf <- data.frame(rbind(x,y,z))

cbind(models = models,rdf)

```


## Analysis of Variance

```{r}
# Create an Anova for the full model
fit.anova <- aov(nested.log, data = df)


# Create a summary of the ANOVA
summary(fit.anova)

# Perform Tukey's

thsd_aov <- TukeyHSD(fit.anova)
summary(thsd_aov)

plot(ci.glht, col = ifelse(pvalues < 0.05, "red", "black"), 
     xlab = "Difference in mean levels")



tuk_surface <- glht(fit.anova, linfct = mcp(Surface_type = "Tukey"))
### p-values
pvalues_surface <- adjusted()(tuk)$pvalues
### get confidence intervals
ci__surface <- confint(tuk)
### plot them
plot(ci__surface, col = ifelse(pvalues < 0.05, "red", "black"), 
     xlab = "Difference in mean levels")

tuk_Angle <- glht(fit.anova, linfct = mcp(Angle = "Tukey"))
### p-values
pvalues_Angle <- adjusted()(tuk)$pvalues
### get confidence intervals
ci__Angle <- confint(tuk)
### plot them
plot(ci__Angle, col = ifelse(pvalues < 0.05, "red", "black"), 
     xlab = "Difference in mean levels")






```


## Outliers

```{r}
potential_outliers <- names(which(abs(residuals(nested.log)) > -qnorm(0.05/2)))
residuals(nested.log)[potential_outliers]
```

